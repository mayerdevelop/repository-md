import { HttpResponse } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { PoHttpInterceptorDetailComponent } from './po-http-interceptor-detail/po-http-interceptor-detail.component';
import { poHttpInterceptorLiterals } from './po-http-interceptor-literals';
const NO_ERROR_HEADER_PARAM = 'X-PO-No-Error';
const NO_MESSAGE_HEADER_PARAM = 'X-PO-No-Message';
/**
 * @description
 *
 * O *interceptor* tem a finalidade de exibir notificações com mensagens na tela, baseado nas respostas das requisições HTTP.
 *
 * Pode ser utilizado para dar feedback das ações do usuário como, por exemplo: erro de autorização, mensagens de regras de negócio,
 * atualizações de registros, erro quando o servidor estiver indisponível e entre outros.
 *
 * ## Configuração
 *
 * Para o correto funcionamento do interceptor `po-http-interceptor`, deve ser importado o `BrowserAnimationsModule` no
 * módulo principal da sua aplicação.
 *
 * Módulo da aplicação:
 * ```
 * import { BrowserAnimationsModule } from '@angular/platform-browser/animations';
 * import { PoModule } from '@po-ui/ng-components';
 * ...
 *
 * @NgModule({
 *   imports: [
 *     BrowserModule,
 *     BrowserAnimationsModule,
 *     ...
 *     PoModule
 *   ],
 *   declarations: [
 *     AppComponent,
 *     ...
 *   ],
 *   providers: [],
 *   bootstrap: [AppComponent]
 * })
 * export class AppModule { }
 * ```
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 * Ao realizar requisições utilize o `HttpClient`, conforme exemplo abaixo:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class UserService {
 *
 *   constructor(private http: HttpClient) { }
 *
 *   getUsers() {
 *     return this.http.get('/api/users');
 *   }
 *
 *   ...
 *
 * }
 * ```
 *
 * ## Como usar
 *
 * Para exibir as noticações é necessário informar a mensagem no retorno da requisição. A estrutura da mensagem
 * é feita com base no status da resposta, conforme será apresentado nos próximos tópicos.
 *
 * ### Estrutura das mensagens
 *
 * #### Mensagens de sucesso `2xx`
 *
 * Para exibir mensagens ao retornar uma lista ou um item, deve-se incluir a propriedade `_messages` no objeto de retorno.
 * Por exemplo:
 * ```
 * {
 *   "_messages": [
 *     {
 *       "type": "success" || "warning" || "error" || "information" (será exibido a `tag` apenas se esta propriedade possuir valor),
 *       "code": "título ou código da mensagem",
 *       "message": "texto da mensagem",
 *       "detailedMessage": "detalhamento da mensagem"
 *     }
 *   ]
 * }
 * ```
 *
 * #### Mensagens de erro `4xx` ou `5xx`
 *
 * Ao retornar erro, o objeto não necessita ter `_messages`, deve-se retornar o objeto diretamente:
 *
 * ```
 * {
 *    "code": "título ou código da mensagem",
 *    "message": "texto da mensagem",
 *    "detailedMessage": "detalhamento da mensagem"
 * }
 * ```
 *
 * Também é possível informar as seguintes propriedades:
 *
 * - `helpUrl`: link para a documentação do erro;
 *    - Caso for informado, será exibido uma ação de "Ajuda" na notificação, para isso não deverá ter a propriedade `detailedMessage`.
 * - `type`: É possível informar `error`, `warning` e `information`, sendo `error` o valor padrão.
 * - `details`: Uma lista de objetos de mensagem (recursiva) com mais detalhes sobre a mensagem principal.
 * - `detailTitle`: caso for informado, será apresentado como título dos detalhes substituindo o padrão `code - message`
 *
 * > Veja o [Guia de implementação de APIs](guides/api) para mais detalhes sobre a estrutura das mensagens.
 *
 * ### Cabeçalho
 *
 * É possível dispensar a notificação para o usuário utilizando no cabeçalho da requisição os parâmetros listados abaixo com o valor
 * igual a `true`:
 *
 * - `X-PO-No-Message`: Não exibe notificações de erro e/ou sucesso.
 *
 * - `X-PO-No-Error`: Não mostra notificações de erro com códigos `4xx` e `5xx`.
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Message': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 *
 * > Após a validação no *interceptor*, os parâmetros serão removidos do cabeçalho da requisição.
 *
 */
export class PoHttpInterceptorBaseService {
    constructor(componentInjector, notification, languageService) {
        this.componentInjector = componentInjector;
        this.notification = notification;
        this.languageService = languageService;
        this.notificationTypes = ['success', 'warning', 'error', 'information'];
        this.literals = poHttpInterceptorLiterals[this.languageService.getShortLanguage()];
        this.httpInterceptorDetailComponent = undefined;
    }
    intercept(request, next) {
        const cloneRequest = request.clone();
        request = request && this.hasParameters(request) ? this.cloneRequestWithoutParameters(request) : request;
        return next.handle(request).pipe(tap((response) => {
            if (response instanceof HttpResponse) {
                this.processResponse(response, cloneRequest);
            }
        }, (error) => {
            this.processErrorResponse(error, cloneRequest);
        }));
    }
    processResponse(response, request) {
        const hasNoMessageParam = this.hasNoMessageParam(request);
        if (!hasNoMessageParam && response.body && response.body._messages) {
            const messages = response.body._messages;
            if (messages instanceof Array) {
                messages.forEach((message) => {
                    this.showNotification(message);
                });
            }
            else {
                this.showNotification(messages);
            }
        }
    }
    processErrorResponse(response, request) {
        const errorResponse = response.status !== 0
            ? response.error
            : { code: 0, message: this.literals.serverNotResponse, detailedMessage: response.message };
        const hasNoErrorParam = this.hasNoErrorParam(request);
        const hasNoMessageParam = this.hasNoMessageParam(request);
        const errorResponseValidTypes = this.notificationTypes.slice(1);
        if (errorResponse && errorResponse.message && !hasNoErrorParam && !hasNoMessageParam) {
            this.showNotification({
                ...errorResponse,
                type: errorResponseValidTypes.includes(errorResponse.type) ? errorResponse.type : 'error'
            });
        }
    }
    cloneRequestWithoutParameters(request) {
        const headers = request.headers.delete(NO_ERROR_HEADER_PARAM).delete(NO_MESSAGE_HEADER_PARAM);
        return request.clone({ headers });
    }
    createModal(responseMessage) {
        const details = responseMessage.details ? [responseMessage, ...responseMessage.details] : [responseMessage];
        this.httpInterceptorDetailComponent = this.componentInjector.createComponentInApplication(PoHttpInterceptorDetailComponent);
        this.httpInterceptorDetailComponent.instance.detail = details;
        this.httpInterceptorDetailComponent.instance.closed.subscribe(() => this.destroyModal());
        this.httpInterceptorDetailComponent.instance.open();
    }
    destroyModal() {
        if (this.httpInterceptorDetailComponent) {
            this.componentInjector.destroyComponentInApplication(this.httpInterceptorDetailComponent);
            this.httpInterceptorDetailComponent = undefined;
        }
    }
    hasMessage(responseMessage) {
        const hasMessageProperties = responseMessage.message;
        return responseMessage && hasMessageProperties;
    }
    hasNoErrorParam(request) {
        const noErrorParam = request && request.headers.get(NO_ERROR_HEADER_PARAM);
        return noErrorParam && noErrorParam.toString().toLocaleLowerCase() === 'true';
    }
    hasNoMessageParam(request) {
        const noMessageParam = request && request.headers.get(NO_MESSAGE_HEADER_PARAM);
        return noMessageParam && noMessageParam.toString().toLocaleLowerCase() === 'true';
    }
    hasParameters(request) {
        return request.headers.has(NO_ERROR_HEADER_PARAM) || request.headers.has(NO_MESSAGE_HEADER_PARAM);
    }
    showNotification(response) {
        if (!this.hasMessage(response)) {
            return;
        }
        const typeNotification = this.notificationTypes.includes(response.type) ? response.type : 'information';
        const notificationAction = this.generateNotificationAction(response);
        this.notification[typeNotification]({
            message: response.message,
            actionLabel: notificationAction.label,
            action: notificationAction.action
        });
    }
    generateDetailModal(responseMessage) {
        return () => {
            if (!this.httpInterceptorDetailComponent) {
                this.createModal(responseMessage);
            }
        };
    }
    generateNotificationAction(responseMessage) {
        let notificationAction;
        let notificationLabel;
        if (responseMessage.helpUrl && !(responseMessage.detailedMessage || responseMessage.details)) {
            notificationLabel = this.literals.help;
            notificationAction = this.generateUrlHelpFunction(responseMessage.helpUrl);
        }
        else if (responseMessage.detailedMessage || responseMessage.details) {
            notificationLabel = this.literals.details;
            notificationAction = this.generateDetailModal(responseMessage);
        }
        return { label: notificationLabel, action: notificationAction };
    }
    generateUrlHelpFunction(helpUrl) {
        return () => {
            window.open(helpUrl, '_blank');
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1pbnRlcmNlcHRvci1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2ludGVyY2VwdG9ycy9wby1odHRwLWludGVyY2VwdG9yL3BvLWh0dHAtaW50ZXJjZXB0b3ItYmFzZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFJTCxZQUFZLEVBR2IsTUFBTSxzQkFBc0IsQ0FBQztBQUc5QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJckMsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sbUVBQW1FLENBQUM7QUFDckgsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFHM0UsTUFBTSxxQkFBcUIsR0FBRyxlQUFlLENBQUM7QUFDOUMsTUFBTSx1QkFBdUIsR0FBRyxpQkFBaUIsQ0FBQztBQUVsRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBOEhHO0FBQ0gsTUFBTSxPQUFnQiw0QkFBNEI7SUFPaEQsWUFDVSxpQkFBNkMsRUFDN0MsWUFBaUIsRUFDakIsZUFBa0M7UUFGbEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUE0QjtRQUM3QyxpQkFBWSxHQUFaLFlBQVksQ0FBSztRQUNqQixvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7UUFUNUMsc0JBQWlCLEdBQUcsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztRQUVuRSxhQUFRLEdBQUcseUJBQXlCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7UUFFdEUsbUNBQThC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SSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQzthQUNuQztRQUNILENBQUMsQ0FBQztJQUNKLENBQUM7SUFFTywwQkFBMEIsQ0FBQyxlQUFvQjtRQUNyRCxJQUFJLGtCQUFrQixDQUFDO1FBQ3ZCLElBQUksaUJBQWlCLENBQUM7UUFFdEIsSUFBSSxlQUFlLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxlQUFlLENBQUMsZUFBZSxJQUFJLGVBQWUsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1RixpQkFBaUIsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztZQUN2QyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQzVFO2FBQU0sSUFBSSxlQUFlLENBQUMsZUFBZSxJQUFJLGVBQWUsQ0FBQyxPQUFPLEVBQUU7WUFDckUsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7WUFDMUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQ2hFO1FBQ0QsT0FBTyxFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRSxNQUFNLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztJQUNsRSxDQUFDO0lBRU8sdUJBQXVCLENBQUMsT0FBZTtRQUM3QyxPQUFPLEdBQUcsRUFBRTtZQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2pDLENBQUMsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgSHR0cEludGVyY2VwdG9yLFxuICBIdHRwSGFuZGxlcixcbiAgSHR0cFJlcXVlc3QsXG4gIEh0dHBSZXNwb25zZSxcbiAgSHR0cEV2ZW50LFxuICBIdHRwRXJyb3JSZXNwb25zZVxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1jb21wb25lbnQtaW5qZWN0b3IvcG8tY29tcG9uZW50LWluamVjdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWwgfSBmcm9tICcuL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0h0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCB9IGZyb20gJy4vcG8taHR0cC1pbnRlcmNlcHRvci1kZXRhaWwvcG8taHR0cC1pbnRlcmNlcHRvci1kZXRhaWwuY29tcG9uZW50JztcbmltcG9ydCB7IHBvSHR0cEludGVyY2VwdG9yTGl0ZXJhbHMgfSBmcm9tICcuL3BvLWh0dHAtaW50ZXJjZXB0b3ItbGl0ZXJhbHMnO1xuaW1wb3J0IHsgUG9MYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5zZXJ2aWNlJztcblxuY29uc3QgTk9fRVJST1JfSEVBREVSX1BBUkFNID0gJ1gtUE8tTm8tRXJyb3InO1xuY29uc3QgTk9fTUVTU0FHRV9IRUFERVJfUEFSQU0gPSAnWC1QTy1Oby1NZXNzYWdlJztcblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqXG4gKiBPICppbnRlcmNlcHRvciogdGVtIGEgZmluYWxpZGFkZSBkZSBleGliaXIgbm90aWZpY2HDp8O1ZXMgY29tIG1lbnNhZ2VucyBuYSB0ZWxhLCBiYXNlYWRvIG5hcyByZXNwb3N0YXMgZGFzIHJlcXVpc2nDp8O1ZXMgSFRUUC5cbiAqXG4gKiBQb2RlIHNlciB1dGlsaXphZG8gcGFyYSBkYXIgZmVlZGJhY2sgZGFzIGHDp8O1ZXMgZG8gdXN1w6FyaW8gY29tbywgcG9yIGV4ZW1wbG86IGVycm8gZGUgYXV0b3JpemHDp8OjbywgbWVuc2FnZW5zIGRlIHJlZ3JhcyBkZSBuZWfDs2NpbyxcbiAqIGF0dWFsaXphw6fDtWVzIGRlIHJlZ2lzdHJvcywgZXJybyBxdWFuZG8gbyBzZXJ2aWRvciBlc3RpdmVyIGluZGlzcG9uw612ZWwgZSBlbnRyZSBvdXRyb3MuXG4gKlxuICogIyMgQ29uZmlndXJhw6fDo29cbiAqXG4gKiBQYXJhIG8gY29ycmV0byBmdW5jaW9uYW1lbnRvIGRvIGludGVyY2VwdG9yIGBwby1odHRwLWludGVyY2VwdG9yYCwgZGV2ZSBzZXIgaW1wb3J0YWRvIG8gYEJyb3dzZXJBbmltYXRpb25zTW9kdWxlYCBub1xuICogbcOzZHVsbyBwcmluY2lwYWwgZGEgc3VhIGFwbGljYcOnw6NvLlxuICpcbiAqIE3Ds2R1bG8gZGEgYXBsaWNhw6fDo286XG4gKiBgYGBcbiAqIGltcG9ydCB7IEJyb3dzZXJBbmltYXRpb25zTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlci9hbmltYXRpb25zJztcbiAqIGltcG9ydCB7IFBvTW9kdWxlIH0gZnJvbSAnQHBvLXVpL25nLWNvbXBvbmVudHMnO1xuICogLi4uXG4gKlxuICogQE5nTW9kdWxlKHtcbiAqICAgaW1wb3J0czogW1xuICogICAgIEJyb3dzZXJNb2R1bGUsXG4gKiAgICAgQnJvd3NlckFuaW1hdGlvbnNNb2R1bGUsXG4gKiAgICAgLi4uXG4gKiAgICAgUG9Nb2R1bGVcbiAqICAgXSxcbiAqICAgZGVjbGFyYXRpb25zOiBbXG4gKiAgICAgQXBwQ29tcG9uZW50LFxuICogICAgIC4uLlxuICogICBdLFxuICogICBwcm92aWRlcnM6IFtdLFxuICogICBib290c3RyYXA6IFtBcHBDb21wb25lbnRdXG4gKiB9KVxuICogZXhwb3J0IGNsYXNzIEFwcE1vZHVsZSB7IH1cbiAqIGBgYFxuICpcbiAqIEFvIGltcG9ydGFyIG8gbcOzZHVsbyBgUG9Nb2R1bGVgIG5hIGFwbGljYcOnw6NvLCBvIGBwby1odHRwLWludGVyY2VwdG9yYCDDqSBhdXRvbWF0aWNhbWVudGUgY29uZmlndXJhZG8gc2VtIGEgbmVjZXNzaWRhZGVcbiAqIGRlIHF1YWxxdWVyIGNvbmZpZ3VyYcOnw6NvIGV4dHJhLlxuICpcbiAqIEFvIHJlYWxpemFyIHJlcXVpc2nDp8O1ZXMgdXRpbGl6ZSBvIGBIdHRwQ2xpZW50YCwgY29uZm9ybWUgZXhlbXBsbyBhYmFpeG86XG4gKlxuICogYGBgXG4gKiBpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuICpcbiAqIC4uLlxuICpcbiAqIEBJbmplY3RhYmxlKClcbiAqIGV4cG9ydCBjbGFzcyBVc2VyU2VydmljZSB7XG4gKlxuICogICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxuICpcbiAqICAgZ2V0VXNlcnMoKSB7XG4gKiAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoJy9hcGkvdXNlcnMnKTtcbiAqICAgfVxuICpcbiAqICAgLi4uXG4gKlxuICogfVxuICogYGBgXG4gKlxuICogIyMgQ29tbyB1c2FyXG4gKlxuICogUGFyYSBleGliaXIgYXMgbm90aWNhw6fDtWVzIMOpIG5lY2Vzc8OhcmlvIGluZm9ybWFyIGEgbWVuc2FnZW0gbm8gcmV0b3JubyBkYSByZXF1aXNpw6fDo28uIEEgZXN0cnV0dXJhIGRhIG1lbnNhZ2VtXG4gKiDDqSBmZWl0YSBjb20gYmFzZSBubyBzdGF0dXMgZGEgcmVzcG9zdGEsIGNvbmZvcm1lIHNlcsOhIGFwcmVzZW50YWRvIG5vcyBwcsOzeGltb3MgdMOzcGljb3MuXG4gKlxuICogIyMjIEVzdHJ1dHVyYSBkYXMgbWVuc2FnZW5zXG4gKlxuICogIyMjIyBNZW5zYWdlbnMgZGUgc3VjZXNzbyBgMnh4YFxuICpcbiAqIFBhcmEgZXhpYmlyIG1lbnNhZ2VucyBhbyByZXRvcm5hciB1bWEgbGlzdGEgb3UgdW0gaXRlbSwgZGV2ZS1zZSBpbmNsdWlyIGEgcHJvcHJpZWRhZGUgYF9tZXNzYWdlc2Agbm8gb2JqZXRvIGRlIHJldG9ybm8uXG4gKiBQb3IgZXhlbXBsbzpcbiAqIGBgYFxuICoge1xuICogICBcIl9tZXNzYWdlc1wiOiBbXG4gKiAgICAge1xuICogICAgICAgXCJ0eXBlXCI6IFwic3VjY2Vzc1wiIHx8IFwid2FybmluZ1wiIHx8IFwiZXJyb3JcIiB8fCBcImluZm9ybWF0aW9uXCIgKHNlcsOhIGV4aWJpZG8gYSBgdGFnYCBhcGVuYXMgc2UgZXN0YSBwcm9wcmllZGFkZSBwb3NzdWlyIHZhbG9yKSxcbiAqICAgICAgIFwiY29kZVwiOiBcInTDrXR1bG8gb3UgY8OzZGlnbyBkYSBtZW5zYWdlbVwiLFxuICogICAgICAgXCJtZXNzYWdlXCI6IFwidGV4dG8gZGEgbWVuc2FnZW1cIixcbiAqICAgICAgIFwiZGV0YWlsZWRNZXNzYWdlXCI6IFwiZGV0YWxoYW1lbnRvIGRhIG1lbnNhZ2VtXCJcbiAqICAgICB9XG4gKiAgIF1cbiAqIH1cbiAqIGBgYFxuICpcbiAqICMjIyMgTWVuc2FnZW5zIGRlIGVycm8gYDR4eGAgb3UgYDV4eGBcbiAqXG4gKiBBbyByZXRvcm5hciBlcnJvLCBvIG9iamV0byBuw6NvIG5lY2Vzc2l0YSB0ZXIgYF9tZXNzYWdlc2AsIGRldmUtc2UgcmV0b3JuYXIgbyBvYmpldG8gZGlyZXRhbWVudGU6XG4gKlxuICogYGBgXG4gKiB7XG4gKiAgICBcImNvZGVcIjogXCJ0w610dWxvIG91IGPDs2RpZ28gZGEgbWVuc2FnZW1cIixcbiAqICAgIFwibWVzc2FnZVwiOiBcInRleHRvIGRhIG1lbnNhZ2VtXCIsXG4gKiAgICBcImRldGFpbGVkTWVzc2FnZVwiOiBcImRldGFsaGFtZW50byBkYSBtZW5zYWdlbVwiXG4gKiB9XG4gKiBgYGBcbiAqXG4gKiBUYW1iw6ltIMOpIHBvc3PDrXZlbCBpbmZvcm1hciBhcyBzZWd1aW50ZXMgcHJvcHJpZWRhZGVzOlxuICpcbiAqIC0gYGhlbHBVcmxgOiBsaW5rIHBhcmEgYSBkb2N1bWVudGHDp8OjbyBkbyBlcnJvO1xuICogICAgLSBDYXNvIGZvciBpbmZvcm1hZG8sIHNlcsOhIGV4aWJpZG8gdW1hIGHDp8OjbyBkZSBcIkFqdWRhXCIgbmEgbm90aWZpY2HDp8OjbywgcGFyYSBpc3NvIG7Do28gZGV2ZXLDoSB0ZXIgYSBwcm9wcmllZGFkZSBgZGV0YWlsZWRNZXNzYWdlYC5cbiAqIC0gYHR5cGVgOiDDiSBwb3Nzw612ZWwgaW5mb3JtYXIgYGVycm9yYCwgYHdhcm5pbmdgIGUgYGluZm9ybWF0aW9uYCwgc2VuZG8gYGVycm9yYCBvIHZhbG9yIHBhZHLDo28uXG4gKiAtIGBkZXRhaWxzYDogVW1hIGxpc3RhIGRlIG9iamV0b3MgZGUgbWVuc2FnZW0gKHJlY3Vyc2l2YSkgY29tIG1haXMgZGV0YWxoZXMgc29icmUgYSBtZW5zYWdlbSBwcmluY2lwYWwuXG4gKiAtIGBkZXRhaWxUaXRsZWA6IGNhc28gZm9yIGluZm9ybWFkbywgc2Vyw6EgYXByZXNlbnRhZG8gY29tbyB0w610dWxvIGRvcyBkZXRhbGhlcyBzdWJzdGl0dWluZG8gbyBwYWRyw6NvIGBjb2RlIC0gbWVzc2FnZWBcbiAqXG4gKiA+IFZlamEgbyBbR3VpYSBkZSBpbXBsZW1lbnRhw6fDo28gZGUgQVBJc10oZ3VpZGVzL2FwaSkgcGFyYSBtYWlzIGRldGFsaGVzIHNvYnJlIGEgZXN0cnV0dXJhIGRhcyBtZW5zYWdlbnMuXG4gKlxuICogIyMjIENhYmXDp2FsaG9cbiAqXG4gKiDDiSBwb3Nzw612ZWwgZGlzcGVuc2FyIGEgbm90aWZpY2HDp8OjbyBwYXJhIG8gdXN1w6FyaW8gdXRpbGl6YW5kbyBubyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8OjbyBvcyBwYXLDom1ldHJvcyBsaXN0YWRvcyBhYmFpeG8gY29tIG8gdmFsb3JcbiAqIGlndWFsIGEgYHRydWVgOlxuICpcbiAqIC0gYFgtUE8tTm8tTWVzc2FnZWA6IE7Do28gZXhpYmUgbm90aWZpY2HDp8O1ZXMgZGUgZXJybyBlL291IHN1Y2Vzc28uXG4gKlxuICogLSBgWC1QTy1Oby1FcnJvcmA6IE7Do28gbW9zdHJhIG5vdGlmaWNhw6fDtWVzIGRlIGVycm8gY29tIGPDs2RpZ29zIGA0eHhgIGUgYDV4eGAuXG4gKlxuICogYGBgXG4gKiAuLi5cbiAqICBjb25zdCBoZWFkZXJzID0geyAnWC1QTy1Oby1NZXNzYWdlJzogJ3RydWUnIH07XG4gKlxuICogIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqIC4uLlxuICpcbiAqIGBgYFxuICpcbiAqID4gQXDDs3MgYSB2YWxpZGHDp8OjbyBubyAqaW50ZXJjZXB0b3IqLCBvcyBwYXLDom1ldHJvcyBzZXLDo28gcmVtb3ZpZG9zIGRvIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvLlxuICpcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFBvSHR0cEludGVyY2VwdG9yQmFzZVNlcnZpY2UgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuICBub3RpZmljYXRpb25UeXBlcyA9IFsnc3VjY2VzcycsICd3YXJuaW5nJywgJ2Vycm9yJywgJ2luZm9ybWF0aW9uJ107XG5cbiAgbGl0ZXJhbHMgPSBwb0h0dHBJbnRlcmNlcHRvckxpdGVyYWxzW3RoaXMubGFuZ3VhZ2VTZXJ2aWNlLmdldFNob3J0TGFuZ3VhZ2UoKV07XG5cbiAgcHJpdmF0ZSBodHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQ6IENvbXBvbmVudFJlZjxQb0h0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudD4gPSB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjb21wb25lbnRJbmplY3RvcjogUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBub3RpZmljYXRpb246IGFueSxcbiAgICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogUG9MYW5ndWFnZVNlcnZpY2VcbiAgKSB7fVxuXG4gIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBjb25zdCBjbG9uZVJlcXVlc3QgPSByZXF1ZXN0LmNsb25lKCk7XG5cbiAgICByZXF1ZXN0ID0gcmVxdWVzdCAmJiB0aGlzLmhhc1BhcmFtZXRlcnMocmVxdWVzdCkgPyB0aGlzLmNsb25lUmVxdWVzdFdpdGhvdXRQYXJhbWV0ZXJzKHJlcXVlc3QpIDogcmVxdWVzdDtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAocmVzcG9uc2U6IEh0dHBFdmVudDxhbnk+KSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NSZXNwb25zZShyZXNwb25zZSwgY2xvbmVSZXF1ZXN0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICB0aGlzLnByb2Nlc3NFcnJvclJlc3BvbnNlKGVycm9yLCBjbG9uZVJlcXVlc3QpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByb2Nlc3NSZXNwb25zZShyZXNwb25zZTogSHR0cFJlc3BvbnNlPGFueT4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBoYXNOb01lc3NhZ2VQYXJhbSA9IHRoaXMuaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdCk7XG5cbiAgICBpZiAoIWhhc05vTWVzc2FnZVBhcmFtICYmIHJlc3BvbnNlLmJvZHkgJiYgcmVzcG9uc2UuYm9keS5fbWVzc2FnZXMpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2VzID0gcmVzcG9uc2UuYm9keS5fbWVzc2FnZXM7XG5cbiAgICAgIGlmIChtZXNzYWdlcyBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgIG1lc3NhZ2VzLmZvckVhY2goKG1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSA9PiB7XG4gICAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2UpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbihtZXNzYWdlcyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvY2Vzc0Vycm9yUmVzcG9uc2UocmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgZXJyb3JSZXNwb25zZSA9XG4gICAgICByZXNwb25zZS5zdGF0dXMgIT09IDBcbiAgICAgICAgPyByZXNwb25zZS5lcnJvclxuICAgICAgICA6IHsgY29kZTogMCwgbWVzc2FnZTogdGhpcy5saXRlcmFscy5zZXJ2ZXJOb3RSZXNwb25zZSwgZGV0YWlsZWRNZXNzYWdlOiByZXNwb25zZS5tZXNzYWdlIH07XG5cbiAgICBjb25zdCBoYXNOb0Vycm9yUGFyYW0gPSB0aGlzLmhhc05vRXJyb3JQYXJhbShyZXF1ZXN0KTtcbiAgICBjb25zdCBoYXNOb01lc3NhZ2VQYXJhbSA9IHRoaXMuaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdCk7XG4gICAgY29uc3QgZXJyb3JSZXNwb25zZVZhbGlkVHlwZXMgPSB0aGlzLm5vdGlmaWNhdGlvblR5cGVzLnNsaWNlKDEpO1xuXG4gICAgaWYgKGVycm9yUmVzcG9uc2UgJiYgZXJyb3JSZXNwb25zZS5tZXNzYWdlICYmICFoYXNOb0Vycm9yUGFyYW0gJiYgIWhhc05vTWVzc2FnZVBhcmFtKSB7XG4gICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24oe1xuICAgICAgICAuLi5lcnJvclJlc3BvbnNlLFxuICAgICAgICB0eXBlOiBlcnJvclJlc3BvbnNlVmFsaWRUeXBlcy5pbmNsdWRlcyhlcnJvclJlc3BvbnNlLnR5cGUpID8gZXJyb3JSZXNwb25zZS50eXBlIDogJ2Vycm9yJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjbG9uZVJlcXVlc3RXaXRob3V0UGFyYW1ldGVycyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogSHR0cFJlcXVlc3Q8YW55PiB7XG4gICAgY29uc3QgaGVhZGVycyA9IHJlcXVlc3QuaGVhZGVycy5kZWxldGUoTk9fRVJST1JfSEVBREVSX1BBUkFNKS5kZWxldGUoTk9fTUVTU0FHRV9IRUFERVJfUEFSQU0pO1xuXG4gICAgcmV0dXJuIHJlcXVlc3QuY2xvbmUoeyBoZWFkZXJzIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNb2RhbChyZXNwb25zZU1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSB7XG4gICAgY29uc3QgZGV0YWlscyA9IHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxzID8gW3Jlc3BvbnNlTWVzc2FnZSwgLi4ucmVzcG9uc2VNZXNzYWdlLmRldGFpbHNdIDogW3Jlc3BvbnNlTWVzc2FnZV07XG5cbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50SW5qZWN0b3IuY3JlYXRlQ29tcG9uZW50SW5BcHBsaWNhdGlvbihcbiAgICAgIFBvSHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50XG4gICAgKTtcbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudC5pbnN0YW5jZS5kZXRhaWwgPSBkZXRhaWxzO1xuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50Lmluc3RhbmNlLmNsb3NlZC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5kZXN0cm95TW9kYWwoKSk7XG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQuaW5zdGFuY2Uub3BlbigpO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95TW9kYWwoKSB7XG4gICAgaWYgKHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KSB7XG4gICAgICB0aGlzLmNvbXBvbmVudEluamVjdG9yLmRlc3Ryb3lDb21wb25lbnRJbkFwcGxpY2F0aW9uKHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KTtcbiAgICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFzTWVzc2FnZShyZXNwb25zZU1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSB7XG4gICAgY29uc3QgaGFzTWVzc2FnZVByb3BlcnRpZXMgPSByZXNwb25zZU1lc3NhZ2UubWVzc2FnZTtcblxuICAgIHJldHVybiByZXNwb25zZU1lc3NhZ2UgJiYgaGFzTWVzc2FnZVByb3BlcnRpZXM7XG4gIH1cblxuICBwcml2YXRlIGhhc05vRXJyb3JQYXJhbShyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgbm9FcnJvclBhcmFtID0gcmVxdWVzdCAmJiByZXF1ZXN0LmhlYWRlcnMuZ2V0KE5PX0VSUk9SX0hFQURFUl9QQVJBTSk7XG5cbiAgICByZXR1cm4gbm9FcnJvclBhcmFtICYmIG5vRXJyb3JQYXJhbS50b1N0cmluZygpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIHByaXZhdGUgaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG5vTWVzc2FnZVBhcmFtID0gcmVxdWVzdCAmJiByZXF1ZXN0LmhlYWRlcnMuZ2V0KE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcblxuICAgIHJldHVybiBub01lc3NhZ2VQYXJhbSAmJiBub01lc3NhZ2VQYXJhbS50b1N0cmluZygpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIHByaXZhdGUgaGFzUGFyYW1ldGVycyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgcmV0dXJuIHJlcXVlc3QuaGVhZGVycy5oYXMoTk9fRVJST1JfSEVBREVSX1BBUkFNKSB8fCByZXF1ZXN0LmhlYWRlcnMuaGFzKE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcbiAgfVxuXG4gIHByaXZhdGUgc2hvd05vdGlmaWNhdGlvbihyZXNwb25zZTogYW55KSB7XG4gICAgaWYgKCF0aGlzLmhhc01lc3NhZ2UocmVzcG9uc2UpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdHlwZU5vdGlmaWNhdGlvbiA9IHRoaXMubm90aWZpY2F0aW9uVHlwZXMuaW5jbHVkZXMocmVzcG9uc2UudHlwZSkgPyByZXNwb25zZS50eXBlIDogJ2luZm9ybWF0aW9uJztcblxuICAgIGNvbnN0IG5vdGlmaWNhdGlvbkFjdGlvbiA9IHRoaXMuZ2VuZXJhdGVOb3RpZmljYXRpb25BY3Rpb24ocmVzcG9uc2UpO1xuXG4gICAgdGhpcy5ub3RpZmljYXRpb25bdHlwZU5vdGlmaWNhdGlvbl0oe1xuICAgICAgbWVzc2FnZTogcmVzcG9uc2UubWVzc2FnZSxcbiAgICAgIGFjdGlvbkxhYmVsOiBub3RpZmljYXRpb25BY3Rpb24ubGFiZWwsXG4gICAgICBhY3Rpb246IG5vdGlmaWNhdGlvbkFjdGlvbi5hY3Rpb25cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVEZXRhaWxNb2RhbChyZXNwb25zZU1lc3NhZ2U6IGFueSkge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMuY3JlYXRlTW9kYWwocmVzcG9uc2VNZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZU5vdGlmaWNhdGlvbkFjdGlvbihyZXNwb25zZU1lc3NhZ2U6IGFueSkge1xuICAgIGxldCBub3RpZmljYXRpb25BY3Rpb247XG4gICAgbGV0IG5vdGlmaWNhdGlvbkxhYmVsO1xuXG4gICAgaWYgKHJlc3BvbnNlTWVzc2FnZS5oZWxwVXJsICYmICEocmVzcG9uc2VNZXNzYWdlLmRldGFpbGVkTWVzc2FnZSB8fCByZXNwb25zZU1lc3NhZ2UuZGV0YWlscykpIHtcbiAgICAgIG5vdGlmaWNhdGlvbkxhYmVsID0gdGhpcy5saXRlcmFscy5oZWxwO1xuICAgICAgbm90aWZpY2F0aW9uQWN0aW9uID0gdGhpcy5nZW5lcmF0ZVVybEhlbHBGdW5jdGlvbihyZXNwb25zZU1lc3NhZ2UuaGVscFVybCk7XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZU1lc3NhZ2UuZGV0YWlsZWRNZXNzYWdlIHx8IHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxzKSB7XG4gICAgICBub3RpZmljYXRpb25MYWJlbCA9IHRoaXMubGl0ZXJhbHMuZGV0YWlscztcbiAgICAgIG5vdGlmaWNhdGlvbkFjdGlvbiA9IHRoaXMuZ2VuZXJhdGVEZXRhaWxNb2RhbChyZXNwb25zZU1lc3NhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4geyBsYWJlbDogbm90aWZpY2F0aW9uTGFiZWwsIGFjdGlvbjogbm90aWZpY2F0aW9uQWN0aW9uIH07XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlVXJsSGVscEZ1bmN0aW9uKGhlbHBVcmw6IHN0cmluZykge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICB3aW5kb3cub3BlbihoZWxwVXJsLCAnX2JsYW5rJyk7XG4gICAgfTtcbiAgfVxufVxuIl19