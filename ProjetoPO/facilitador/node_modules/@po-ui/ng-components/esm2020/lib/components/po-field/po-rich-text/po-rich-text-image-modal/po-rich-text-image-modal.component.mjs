import { Component, EventEmitter, Output, ViewChild } from '@angular/core';
import { convertImageToBase64 } from '../../../../utils/util';
import { poRichTextLiteralsDefault } from '../po-rich-text-literals';
import * as i0 from "@angular/core";
import * as i1 from "./../../../../services/po-language/po-language.service";
import * as i2 from "@angular/forms";
import * as i3 from "../../../po-modal/po-modal.component";
import * as i4 from "../../po-upload/po-upload.component";
import * as i5 from "../../po-url/po-url.component";
const _c0 = ["modal"];
const _c1 = ["modalImageForm"];
const _c2 = ["upload"];
const uploadRestrictions = ['.apng', '.bmp', '.gif', '.ico', '.jpeg', '.jpg', '.png', '.svg'];
export class PoRichTextImageModalComponent {
    constructor(languageService) {
        this.languageService = languageService;
        this.command = new EventEmitter();
        this.selection = document.getSelection();
        this.uploadRestrictions = {
            allowedExtensions: uploadRestrictions
        };
        this.literals = {
            ...poRichTextLiteralsDefault[this.languageService.getShortLanguage()]
        };
        this.modalCancelAction = {
            label: this.literals.cancel,
            action: () => {
                this.modal.close();
                this.command.emit();
                this.retrieveCursorPosition();
                this.cleanUpFields();
            }
        };
        this.modalConfirmAction = {
            label: this.literals.insert,
            disabled: false,
            action: () => this.insertElementRef()
        };
    }
    get isUploadValid() {
        return !!(this.uploadModel && this.uploadModel.length);
    }
    get isUrlValid() {
        return !!this.urlImage && this.modalImageForm && this.modalImageForm.valid;
    }
    openModal() {
        this.saveCursorPosition();
        this.modal.open();
    }
    cleanUpFields() {
        this.urlImage = undefined;
        this.uploadModel = undefined;
    }
    async convertToBase64() {
        if (this.isUploadValid) {
            const uploadImage = this.uploadModel[0].rawFile;
            return await convertImageToBase64(uploadImage);
        }
    }
    emitCommand(value) {
        let command;
        if (value) {
            command = 'insertImage';
            this.command.emit({ command, value });
        }
    }
    async insertElementRef() {
        let uploadImage;
        if (!this.urlImage) {
            uploadImage = await this.convertToBase64();
        }
        this.retrieveCursorPosition();
        this.modal.close();
        if (this.isUrlValid || this.isUploadValid) {
            this.emitCommand(this.urlImage || uploadImage);
        }
        this.cleanUpFields();
    }
    retrieveCursorPosition() {
        this.selection.collapse(this.savedCursorPosition[0], this.savedCursorPosition[1]);
    }
    saveCursorPosition() {
        this.savedCursorPosition = [this.selection.focusNode, this.selection.focusOffset];
    }
}
PoRichTextImageModalComponent.ɵfac = function PoRichTextImageModalComponent_Factory(t) { return new (t || PoRichTextImageModalComponent)(i0.ɵɵdirectiveInject(i1.PoLanguageService)); };
PoRichTextImageModalComponent.ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent({ type: PoRichTextImageModalComponent, selectors: [["po-rich-text-image-modal"]], viewQuery: function PoRichTextImageModalComponent_Query(rf, ctx) { if (rf & 1) {
        i0.ɵɵviewQuery(_c0, 7);
        i0.ɵɵviewQuery(_c1, 5);
        i0.ɵɵviewQuery(_c2, 7);
    } if (rf & 2) {
        let _t;
        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.modal = _t.first);
        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.modalImageForm = _t.first);
        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.upload = _t.first);
    } }, outputs: { command: "p-command" }, decls: 9, vars: 10, consts: [["p-hide-close", "", 3, "p-primary-action", "p-secondary-action", "p-title"], ["modal", ""], ["modalImageForm", "ngForm"], [1, "po-row"], ["name", "upload", "p-drag-drop-height", "160", "p-hide-restrictions-info", "", "p-hide-send-button", "", "p-url", "x", 1, "po-md-12", 3, "ngModel", "p-drag-drop", "p-disabled", "p-restrictions", "ngModelChange"], ["upload", ""], ["name", "url", 1, "po-md-12", "po-mt-3", 3, "ngModel", "p-label", "p-disabled", "ngModelChange"]], template: function PoRichTextImageModalComponent_Template(rf, ctx) { if (rf & 1) {
        i0.ɵɵelementStart(0, "po-modal", 0, 1)(2, "form", null, 2)(4, "div", 3)(5, "po-upload", 4, 5);
        i0.ɵɵlistener("ngModelChange", function PoRichTextImageModalComponent_Template_po_upload_ngModelChange_5_listener($event) { return ctx.uploadModel = $event; });
        i0.ɵɵelementEnd()();
        i0.ɵɵelementStart(7, "div", 3)(8, "po-url", 6);
        i0.ɵɵlistener("ngModelChange", function PoRichTextImageModalComponent_Template_po_url_ngModelChange_8_listener($event) { return ctx.urlImage = $event; });
        i0.ɵɵelementEnd()()()();
    } if (rf & 2) {
        const _r0 = i0.ɵɵreference(1);
        i0.ɵɵproperty("p-primary-action", ctx.modalConfirmAction)("p-secondary-action", ctx.modalCancelAction)("p-title", ctx.literals.insertImage);
        i0.ɵɵadvance(5);
        i0.ɵɵproperty("ngModel", ctx.uploadModel)("p-drag-drop", !_r0.isHidden)("p-disabled", ctx.isUrlValid)("p-restrictions", ctx.uploadRestrictions);
        i0.ɵɵadvance(3);
        i0.ɵɵproperty("ngModel", ctx.urlImage)("p-label", ctx.literals.urlImage)("p-disabled", ctx.isUploadValid);
    } }, dependencies: [i2.ɵNgNoValidate, i2.NgControlStatus, i2.NgControlStatusGroup, i2.NgModel, i2.NgForm, i3.PoModalComponent, i4.PoUploadComponent, i5.PoUrlComponent], encapsulation: 2 });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoRichTextImageModalComponent, [{
        type: Component,
        args: [{ selector: 'po-rich-text-image-modal', template: "<po-modal\n  #modal\n  p-hide-close\n  [p-primary-action]=\"modalConfirmAction\"\n  [p-secondary-action]=\"modalCancelAction\"\n  [p-title]=\"literals.insertImage\"\n>\n  <form #modalImageForm=\"ngForm\">\n    <div class=\"po-row\">\n      <!-- po-upload desabilita o drag drop caso n\u00E3o tenha valor atribuido para a propriedade p-url -->\n      <po-upload\n        #upload\n        class=\"po-md-12\"\n        name=\"upload\"\n        [(ngModel)]=\"uploadModel\"\n        p-drag-drop-height=\"160\"\n        p-hide-restrictions-info\n        p-hide-send-button\n        p-url=\"x\"\n        [p-drag-drop]=\"!modal.isHidden\"\n        [p-disabled]=\"isUrlValid\"\n        [p-restrictions]=\"uploadRestrictions\"\n      >\n      </po-upload>\n    </div>\n\n    <div class=\"po-row\">\n      <po-url\n        class=\"po-md-12 po-mt-3\"\n        name=\"url\"\n        [(ngModel)]=\"urlImage\"\n        [p-label]=\"literals.urlImage\"\n        [p-disabled]=\"isUploadValid\"\n      >\n      </po-url>\n    </div>\n  </form>\n</po-modal>\n" }]
    }], function () { return [{ type: i1.PoLanguageService }]; }, { modal: [{
            type: ViewChild,
            args: ['modal', { static: true }]
        }], modalImageForm: [{
            type: ViewChild,
            args: ['modalImageForm']
        }], upload: [{
            type: ViewChild,
            args: ['upload', { static: true }]
        }], command: [{
            type: Output,
            args: ['p-command']
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LWltYWdlLW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1maWVsZC9wby1yaWNoLXRleHQvcG8tcmljaC10ZXh0LWltYWdlLW1vZGFsL3BvLXJpY2gtdGV4dC1pbWFnZS1tb2RhbC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2NvbXBvbmVudHMvcG8tZmllbGQvcG8tcmljaC10ZXh0L3BvLXJpY2gtdGV4dC1pbWFnZS1tb2RhbC9wby1yaWNoLXRleHQtaW1hZ2UtbW9kYWwuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQVUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUduRixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUk5RCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7Ozs7Ozs7OztBQUlyRSxNQUFNLGtCQUFrQixHQUFHLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBTTlGLE1BQU0sT0FBTyw2QkFBNkI7SUE2Q3hDLFlBQW9CLGVBQWtDO1FBQWxDLG9CQUFlLEdBQWYsZUFBZSxDQUFtQjtRQXRDakMsWUFBTyxHQUFHLElBQUksWUFBWSxFQUFxRCxDQUFDO1FBR3JHLGNBQVMsR0FBRyxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFcEMsdUJBQWtCLEdBQTZCO1lBQzdDLGlCQUFpQixFQUFFLGtCQUFrQjtTQUN0QyxDQUFDO1FBR08sYUFBUSxHQUFHO1lB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Q0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRixDQUFDOzswR0E5RlUsNkJBQTZCO2dGQUE3Qiw2QkFBNkI7Ozs7Ozs7Ozs7UUNqQjFDLHNDQU1DLG9CQUFBLGFBQUEsc0JBQUE7UUFRTywrSkFBeUI7UUFTM0IsaUJBQVksRUFBQTtRQUdkLDhCQUFvQixnQkFBQTtRQUloQix5SkFBc0I7UUFJeEIsaUJBQVMsRUFBQSxFQUFBLEVBQUE7OztRQS9CYix5REFBdUMsNkNBQUEscUNBQUE7UUFXakMsZUFBeUI7UUFBekIseUNBQXlCLDhCQUFBLDhCQUFBLDBDQUFBO1FBZ0J6QixlQUFzQjtRQUF0QixzQ0FBc0Isa0NBQUEsaUNBQUE7O3VGRGJqQiw2QkFBNkI7Y0FKekMsU0FBUzsyQkFDRSwwQkFBMEI7b0VBSUUsS0FBSztrQkFBMUMsU0FBUzttQkFBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO1lBRVAsY0FBYztrQkFBMUMsU0FBUzttQkFBQyxnQkFBZ0I7WUFFWSxNQUFNO2tCQUE1QyxTQUFTO21CQUFDLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7WUFFaEIsT0FBTztrQkFBM0IsTUFBTTttQkFBQyxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIE9uSW5pdCwgT3V0cHV0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5pbXBvcnQgeyBjb252ZXJ0SW1hZ2VUb0Jhc2U2NCB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xuaW1wb3J0IHsgUG9MYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLy4uLy4uLy4uLy4uL3NlcnZpY2VzL3BvLWxhbmd1YWdlL3BvLWxhbmd1YWdlLnNlcnZpY2UnO1xuXG5pbXBvcnQgeyBQb01vZGFsQWN0aW9uLCBQb01vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vLi4vcG8tbW9kYWwnO1xuaW1wb3J0IHsgcG9SaWNoVGV4dExpdGVyYWxzRGVmYXVsdCB9IGZyb20gJy4uL3BvLXJpY2gtdGV4dC1saXRlcmFscyc7XG5pbXBvcnQgeyBQb1VwbG9hZENvbXBvbmVudCB9IGZyb20gJy4uLy4uL3BvLXVwbG9hZC9wby11cGxvYWQuY29tcG9uZW50JztcbmltcG9ydCB7IFBvVXBsb2FkRmlsZVJlc3RyaWN0aW9ucyB9IGZyb20gJy4uLy4uL3BvLXVwbG9hZC9pbnRlcmZhY2VzL3BvLXVwbG9hZC1maWxlLXJlc3RyaWN0aW9uLmludGVyZmFjZSc7XG5cbmNvbnN0IHVwbG9hZFJlc3RyaWN0aW9ucyA9IFsnLmFwbmcnLCAnLmJtcCcsICcuZ2lmJywgJy5pY28nLCAnLmpwZWcnLCAnLmpwZycsICcucG5nJywgJy5zdmcnXTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tcmljaC10ZXh0LWltYWdlLW1vZGFsJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLXJpY2gtdGV4dC1pbWFnZS1tb2RhbC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgUG9SaWNoVGV4dEltYWdlTW9kYWxDb21wb25lbnQge1xuICBAVmlld0NoaWxkKCdtb2RhbCcsIHsgc3RhdGljOiB0cnVlIH0pIG1vZGFsOiBQb01vZGFsQ29tcG9uZW50O1xuXG4gIEBWaWV3Q2hpbGQoJ21vZGFsSW1hZ2VGb3JtJykgbW9kYWxJbWFnZUZvcm06IE5nRm9ybTtcblxuICBAVmlld0NoaWxkKCd1cGxvYWQnLCB7IHN0YXRpYzogdHJ1ZSB9KSB1cGxvYWQ6IFBvVXBsb2FkQ29tcG9uZW50O1xuXG4gIEBPdXRwdXQoJ3AtY29tbWFuZCcpIGNvbW1hbmQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZyB8IHsgY29tbWFuZDogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIHwgYW55IH0+KCk7XG5cbiAgc2F2ZWRDdXJzb3JQb3NpdGlvbjtcbiAgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XG4gIHVwbG9hZE1vZGVsOiBBcnJheTxhbnk+O1xuICB1cGxvYWRSZXN0cmljdGlvbnM6IFBvVXBsb2FkRmlsZVJlc3RyaWN0aW9ucyA9IHtcbiAgICBhbGxvd2VkRXh0ZW5zaW9uczogdXBsb2FkUmVzdHJpY3Rpb25zXG4gIH07XG4gIHVybEltYWdlOiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkgbGl0ZXJhbHMgPSB7XG4gICAgLi4ucG9SaWNoVGV4dExpdGVyYWxzRGVmYXVsdFt0aGlzLmxhbmd1YWdlU2VydmljZS5nZXRTaG9ydExhbmd1YWdlKCldXG4gIH07XG5cbiAgbW9kYWxDYW5jZWxBY3Rpb246IFBvTW9kYWxBY3Rpb24gPSB7XG4gICAgbGFiZWw6IHRoaXMubGl0ZXJhbHMuY2FuY2VsLFxuICAgIGFjdGlvbjogKCkgPT4ge1xuICAgICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xuICAgICAgdGhpcy5jb21tYW5kLmVtaXQoKTtcbiAgICAgIHRoaXMucmV0cmlldmVDdXJzb3JQb3NpdGlvbigpO1xuICAgICAgdGhpcy5jbGVhblVwRmllbGRzKCk7XG4gICAgfVxuICB9O1xuXG4gIG1vZGFsQ29uZmlybUFjdGlvbjogUG9Nb2RhbEFjdGlvbiA9IHtcbiAgICBsYWJlbDogdGhpcy5saXRlcmFscy5pbnNlcnQsXG4gICAgZGlzYWJsZWQ6IGZhbHNlLFxuICAgIGFjdGlvbjogKCkgPT4gdGhpcy5pbnNlcnRFbGVtZW50UmVmKClcbiAgfTtcblxuICBnZXQgaXNVcGxvYWRWYWxpZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISEodGhpcy51cGxvYWRNb2RlbCAmJiB0aGlzLnVwbG9hZE1vZGVsLmxlbmd0aCk7XG4gIH1cblxuICBnZXQgaXNVcmxWYWxpZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLnVybEltYWdlICYmIHRoaXMubW9kYWxJbWFnZUZvcm0gJiYgdGhpcy5tb2RhbEltYWdlRm9ybS52YWxpZDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBQb0xhbmd1YWdlU2VydmljZSkge31cblxuICBvcGVuTW9kYWwoKSB7XG4gICAgdGhpcy5zYXZlQ3Vyc29yUG9zaXRpb24oKTtcbiAgICB0aGlzLm1vZGFsLm9wZW4oKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW5VcEZpZWxkcygpIHtcbiAgICB0aGlzLnVybEltYWdlID0gdW5kZWZpbmVkO1xuICAgIHRoaXMudXBsb2FkTW9kZWwgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNvbnZlcnRUb0Jhc2U2NCgpIHtcbiAgICBpZiAodGhpcy5pc1VwbG9hZFZhbGlkKSB7XG4gICAgICBjb25zdCB1cGxvYWRJbWFnZSA9IHRoaXMudXBsb2FkTW9kZWxbMF0ucmF3RmlsZTtcbiAgICAgIHJldHVybiBhd2FpdCBjb252ZXJ0SW1hZ2VUb0Jhc2U2NCh1cGxvYWRJbWFnZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBlbWl0Q29tbWFuZCh2YWx1ZSkge1xuICAgIGxldCBjb21tYW5kOiBzdHJpbmc7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICBjb21tYW5kID0gJ2luc2VydEltYWdlJztcbiAgICAgIHRoaXMuY29tbWFuZC5lbWl0KHsgY29tbWFuZCwgdmFsdWUgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbnNlcnRFbGVtZW50UmVmKCkge1xuICAgIGxldCB1cGxvYWRJbWFnZTogc3RyaW5nO1xuXG4gICAgaWYgKCF0aGlzLnVybEltYWdlKSB7XG4gICAgICB1cGxvYWRJbWFnZSA9IGF3YWl0IHRoaXMuY29udmVydFRvQmFzZTY0KCk7XG4gICAgfVxuXG4gICAgdGhpcy5yZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCk7XG4gICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xuXG4gICAgaWYgKHRoaXMuaXNVcmxWYWxpZCB8fCB0aGlzLmlzVXBsb2FkVmFsaWQpIHtcbiAgICAgIHRoaXMuZW1pdENvbW1hbmQodGhpcy51cmxJbWFnZSB8fCB1cGxvYWRJbWFnZSk7XG4gICAgfVxuICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCkge1xuICAgIHRoaXMuc2VsZWN0aW9uLmNvbGxhcHNlKHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvblswXSwgdGhpcy5zYXZlZEN1cnNvclBvc2l0aW9uWzFdKTtcbiAgfVxuXG4gIHByaXZhdGUgc2F2ZUN1cnNvclBvc2l0aW9uKCkge1xuICAgIHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvbiA9IFt0aGlzLnNlbGVjdGlvbi5mb2N1c05vZGUsIHRoaXMuc2VsZWN0aW9uLmZvY3VzT2Zmc2V0XTtcbiAgfVxufVxuIiwiPHBvLW1vZGFsXG4gICNtb2RhbFxuICBwLWhpZGUtY2xvc2VcbiAgW3AtcHJpbWFyeS1hY3Rpb25dPVwibW9kYWxDb25maXJtQWN0aW9uXCJcbiAgW3Atc2Vjb25kYXJ5LWFjdGlvbl09XCJtb2RhbENhbmNlbEFjdGlvblwiXG4gIFtwLXRpdGxlXT1cImxpdGVyYWxzLmluc2VydEltYWdlXCJcbj5cbiAgPGZvcm0gI21vZGFsSW1hZ2VGb3JtPVwibmdGb3JtXCI+XG4gICAgPGRpdiBjbGFzcz1cInBvLXJvd1wiPlxuICAgICAgPCEtLSBwby11cGxvYWQgZGVzYWJpbGl0YSBvIGRyYWcgZHJvcCBjYXNvIG7Do28gdGVuaGEgdmFsb3IgYXRyaWJ1aWRvIHBhcmEgYSBwcm9wcmllZGFkZSBwLXVybCAtLT5cbiAgICAgIDxwby11cGxvYWRcbiAgICAgICAgI3VwbG9hZFxuICAgICAgICBjbGFzcz1cInBvLW1kLTEyXCJcbiAgICAgICAgbmFtZT1cInVwbG9hZFwiXG4gICAgICAgIFsobmdNb2RlbCldPVwidXBsb2FkTW9kZWxcIlxuICAgICAgICBwLWRyYWctZHJvcC1oZWlnaHQ9XCIxNjBcIlxuICAgICAgICBwLWhpZGUtcmVzdHJpY3Rpb25zLWluZm9cbiAgICAgICAgcC1oaWRlLXNlbmQtYnV0dG9uXG4gICAgICAgIHAtdXJsPVwieFwiXG4gICAgICAgIFtwLWRyYWctZHJvcF09XCIhbW9kYWwuaXNIaWRkZW5cIlxuICAgICAgICBbcC1kaXNhYmxlZF09XCJpc1VybFZhbGlkXCJcbiAgICAgICAgW3AtcmVzdHJpY3Rpb25zXT1cInVwbG9hZFJlc3RyaWN0aW9uc1wiXG4gICAgICA+XG4gICAgICA8L3BvLXVwbG9hZD5cbiAgICA8L2Rpdj5cblxuICAgIDxkaXYgY2xhc3M9XCJwby1yb3dcIj5cbiAgICAgIDxwby11cmxcbiAgICAgICAgY2xhc3M9XCJwby1tZC0xMiBwby1tdC0zXCJcbiAgICAgICAgbmFtZT1cInVybFwiXG4gICAgICAgIFsobmdNb2RlbCldPVwidXJsSW1hZ2VcIlxuICAgICAgICBbcC1sYWJlbF09XCJsaXRlcmFscy51cmxJbWFnZVwiXG4gICAgICAgIFtwLWRpc2FibGVkXT1cImlzVXBsb2FkVmFsaWRcIlxuICAgICAgPlxuICAgICAgPC9wby11cmw+XG4gICAgPC9kaXY+XG4gIDwvZm9ybT5cbjwvcG8tbW9kYWw+XG4iXX0=