import { EventEmitter, Input, Output, Directive } from '@angular/core';
import { convertToBoolean } from '../../utils/util';
import * as i0 from "@angular/core";
const poTreeViewMaxLevel = 4;
/**
 * @description
 *
 * O componente fornece um modelo de visualização em árvore, possibilitando a visualização das informações de maneira
 * hierárquica, desta forma sendo possível utilizar até 4 níveis.
 *
 * Nele é possível navegar entre os itens através da tecla *tab*, permitindo expandir ou colapsar o item em foco
 * por meio das teclas *enter* e *space*.
 *
 * Além da navegação, o componente possibilita também a seleção dos itens do primeiro ao último nível, tanto de forma parcial como completa.
 *
 * O componente também possui eventos disparados ao marcar/desmarcar e expandir/colapsar os itens.
 */
export class PoTreeViewBaseComponent {
    constructor() {
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao colapsar um item.
         *
         * > Como parâmetro o componente envia o item colapsado.
         */
        this.collapsed = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao expandir um item.
         *
         * > Como parâmetro o componente envia o item expandido.
         */
        this.expanded = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao selecionar um item.
         *
         * > Como parâmetro o componente envia o item selecionado.
         */
        this.selected = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao desfazer a seleção de um item.
         *
         * > Como parâmetro o componente envia o item que foi desmarcado.
         */
        this.unselected = new EventEmitter();
        this._items = [];
        this._selectable = false;
    }
    /**
     * Lista de itens do tipo `PoTreeViewItem` que será renderizada pelo componente.
     */
    set items(value) {
        this._items = Array.isArray(value) ? this.getItemsByMaxLevel(value) : [];
    }
    get items() {
        return this._items;
    }
    /**
     * @optional
     *
     * @description
     *
     * Habilita uma caixa de seleção para selecionar e/ou desmarcar um item da lista.
     *
     * @default false
     */
    set selectable(value) {
        this._selectable = convertToBoolean(value);
    }
    get selectable() {
        return this._selectable;
    }
    emitExpanded(treeViewItem) {
        const event = treeViewItem.expanded ? 'expanded' : 'collapsed';
        this[event].emit({ ...treeViewItem });
    }
    emitSelected(treeViewItem) {
        const event = treeViewItem.selected ? 'selected' : 'unselected';
        this.updateItemsOnSelect(treeViewItem);
        this[event].emit({ ...treeViewItem });
    }
    addChildItemInParent(childItem, parentItem) {
        if (!parentItem.subItems) {
            parentItem.subItems = [];
        }
        parentItem.subItems.push(childItem);
    }
    // caso houver parentItem:
    //  - expande o parentItem caso o filho estiver expandido;
    //  - adiciona o childItem no parentItem;
    //  - marca o parentItem caso conter subItems marcodos ou nulos;
    // Se não conter parentItem, adiciona o childItem no items.
    addItem(items, childItem, parentItem) {
        if (parentItem) {
            this.expandParentItem(childItem, parentItem);
            this.addChildItemInParent(childItem, parentItem);
            this.selectItemBySubItems(parentItem);
            items.push(parentItem);
        }
        else {
            items.push(childItem);
        }
    }
    selectAllItems(items, isSelected) {
        items.forEach(item => {
            if (item.subItems) {
                this.selectAllItems(item.subItems, isSelected);
            }
            item.selected = isSelected;
        });
    }
    selectItemBySubItems(item) {
        item.selected = this.everyItemSelected(item.subItems);
    }
    // retornará:
    //  - true: se todos os items estiverem marcados;
    //  - null: se no minimo um item esteja marcado ou nullo (indeterminate)
    //  - false: caso não corresponda em nenhuma das opções acima, no caso, nenhum marcado ou nulo;
    everyItemSelected(items = []) {
        const itemsLength = items.length;
        const lengthCheckedItems = items.filter(item => item.selected).length;
        if (itemsLength && itemsLength === lengthCheckedItems) {
            return true;
        }
        const hasIndeterminateItems = items.filter(item => item.selected || item.selected === null).length;
        if (hasIndeterminateItems) {
            return null;
        }
        return false;
    }
    // expande o item pai caso o filho estiver expandido.
    expandParentItem(childItem, parentItem) {
        if (childItem.expanded) {
            parentItem.expanded = true;
        }
    }
    getItemsByMaxLevel(items = [], level = 0, parentItem, newItems = []) {
        items.forEach(item => {
            const { subItems, ...currentItem } = item;
            if (level === poTreeViewMaxLevel) {
                return;
            }
            if (Array.isArray(subItems)) {
                // caso um item pai iniciar selecionado, deve selecionar os filhos.
                if (currentItem.selected) {
                    this.selectAllItems(subItems, currentItem.selected);
                }
                this.getItemsByMaxLevel(subItems, ++level, currentItem);
                --level;
            }
            this.addItem(newItems, currentItem, parentItem);
        });
        return newItems;
    }
    getItemsWithParentSelected(items = [], parentItem, newItems = []) {
        items.forEach(item => {
            const { subItems, ...currentItem } = item;
            if (Array.isArray(subItems)) {
                this.getItemsWithParentSelected(subItems, currentItem);
            }
            this.addItem(newItems, currentItem, parentItem);
        });
        return newItems;
    }
    updateItemsOnSelect(selectedItem) {
        if (selectedItem.subItems) {
            this.selectAllItems(selectedItem.subItems, selectedItem.selected);
        }
        this._items = this.getItemsWithParentSelected(this.items);
    }
}
PoTreeViewBaseComponent.ɵfac = function PoTreeViewBaseComponent_Factory(t) { return new (t || PoTreeViewBaseComponent)(); };
PoTreeViewBaseComponent.ɵdir = /*@__PURE__*/ i0.ɵɵdefineDirective({ type: PoTreeViewBaseComponent, inputs: { items: ["p-items", "items"], selectable: ["p-selectable", "selectable"] }, outputs: { collapsed: "p-collapsed", expanded: "p-expanded", selected: "p-selected", unselected: "p-unselected" } });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoTreeViewBaseComponent, [{
        type: Directive
    }], null, { collapsed: [{
            type: Output,
            args: ['p-collapsed']
        }], expanded: [{
            type: Output,
            args: ['p-expanded']
        }], selected: [{
            type: Output,
            args: ['p-selected']
        }], unselected: [{
            type: Output,
            args: ['p-unselected']
        }], items: [{
            type: Input,
            args: ['p-items']
        }], selectable: [{
            type: Input,
            args: ['p-selectable']
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdHJlZS12aWV3LWJhc2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLXRyZWUtdmlldy9wby10cmVlLXZpZXctYmFzZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV2RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7QUFJcEQsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFFN0I7Ozs7Ozs7Ozs7OztHQVlHO0FBRUgsTUFBTSxPQUFPLHVCQUF1QjtJQURwQztRQUVFOzs7Ozs7OztXQVFHO1FBQ29CLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBa0IsQ0FBQztRQUV0RTs7Ozs7Ozs7V0FRRztRQUNtQixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQWtCLENBQUM7UUFFcEU7Ozs7Ozs7O1dBUUc7UUFDbUIsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFrQixDQUFDO1FBRXBFOzs7Ozs7OztXQVFHO1FBQ3FCLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBa0IsQ0FBQztRQUVoRSxXQUFNLEdBQTBCLEVBQUUsQ0FBQztRQUNuQyxnQkFBVyxHQUFZLEtBQUssQ0FBQztLQWtLdEM7SUFoS0M7O09BRUc7SUFDSCxJQUFzQixLQUFLLENBQUMsS0FBNEI7UUFDdEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUMzRSxDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFD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LCBEaXJlY3RpdmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgY29udmVydFRvQm9vbGVhbiB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWwnO1xuXG5pbXBvcnQgeyBQb1RyZWVWaWV3SXRlbSB9IGZyb20gJy4vcG8tdHJlZS12aWV3LWl0ZW0vcG8tdHJlZS12aWV3LWl0ZW0uaW50ZXJmYWNlJztcblxuY29uc3QgcG9UcmVlVmlld01heExldmVsID0gNDtcblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqXG4gKiBPIGNvbXBvbmVudGUgZm9ybmVjZSB1bSBtb2RlbG8gZGUgdmlzdWFsaXphw6fDo28gZW0gw6Fydm9yZSwgcG9zc2liaWxpdGFuZG8gYSB2aXN1YWxpemHDp8OjbyBkYXMgaW5mb3JtYcOnw7VlcyBkZSBtYW5laXJhXG4gKiBoaWVyw6FycXVpY2EsIGRlc3RhIGZvcm1hIHNlbmRvIHBvc3PDrXZlbCB1dGlsaXphciBhdMOpIDQgbsOtdmVpcy5cbiAqXG4gKiBOZWxlIMOpIHBvc3PDrXZlbCBuYXZlZ2FyIGVudHJlIG9zIGl0ZW5zIGF0cmF2w6lzIGRhIHRlY2xhICp0YWIqLCBwZXJtaXRpbmRvIGV4cGFuZGlyIG91IGNvbGFwc2FyIG8gaXRlbSBlbSBmb2NvXG4gKiBwb3IgbWVpbyBkYXMgdGVjbGFzICplbnRlciogZSAqc3BhY2UqLlxuICpcbiAqIEFsw6ltIGRhIG5hdmVnYcOnw6NvLCBvIGNvbXBvbmVudGUgcG9zc2liaWxpdGEgdGFtYsOpbSBhIHNlbGXDp8OjbyBkb3MgaXRlbnMgZG8gcHJpbWVpcm8gYW8gw7psdGltbyBuw612ZWwsIHRhbnRvIGRlIGZvcm1hIHBhcmNpYWwgY29tbyBjb21wbGV0YS5cbiAqXG4gKiBPIGNvbXBvbmVudGUgdGFtYsOpbSBwb3NzdWkgZXZlbnRvcyBkaXNwYXJhZG9zIGFvIG1hcmNhci9kZXNtYXJjYXIgZSBleHBhbmRpci9jb2xhcHNhciBvcyBpdGVucy5cbiAqL1xuQERpcmVjdGl2ZSgpXG5leHBvcnQgY2xhc3MgUG9UcmVlVmlld0Jhc2VDb21wb25lbnQge1xuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBBw6fDo28gcXVlIHNlcsOhIGRpc3BhcmFkYSBhbyBjb2xhcHNhciB1bSBpdGVtLlxuICAgKlxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIGNvbGFwc2Fkby5cbiAgICovXG4gIEBPdXRwdXQoJ3AtY29sbGFwc2VkJykgY29sbGFwc2VkID0gbmV3IEV2ZW50RW1pdHRlcjxQb1RyZWVWaWV3SXRlbT4oKTtcblxuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBBw6fDo28gcXVlIHNlcsOhIGRpc3BhcmFkYSBhbyBleHBhbmRpciB1bSBpdGVtLlxuICAgKlxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIGV4cGFuZGlkby5cbiAgICovXG4gIEBPdXRwdXQoJ3AtZXhwYW5kZWQnKSBleHBhbmRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8UG9UcmVlVmlld0l0ZW0+KCk7XG5cbiAgLyoqXG4gICAqIEBvcHRpb25hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogQcOnw6NvIHF1ZSBzZXLDoSBkaXNwYXJhZGEgYW8gc2VsZWNpb25hciB1bSBpdGVtLlxuICAgKlxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIHNlbGVjaW9uYWRvLlxuICAgKi9cbiAgQE91dHB1dCgncC1zZWxlY3RlZCcpIHNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxQb1RyZWVWaWV3SXRlbT4oKTtcblxuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBBw6fDo28gcXVlIHNlcsOhIGRpc3BhcmFkYSBhbyBkZXNmYXplciBhIHNlbGXDp8OjbyBkZSB1bSBpdGVtLlxuICAgKlxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIHF1ZSBmb2kgZGVzbWFyY2Fkby5cbiAgICovXG4gIEBPdXRwdXQoJ3AtdW5zZWxlY3RlZCcpIHVuc2VsZWN0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPFBvVHJlZVZpZXdJdGVtPigpO1xuXG4gIHByaXZhdGUgX2l0ZW1zOiBBcnJheTxQb1RyZWVWaWV3SXRlbT4gPSBbXTtcbiAgcHJpdmF0ZSBfc2VsZWN0YWJsZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBMaXN0YSBkZSBpdGVucyBkbyB0aXBvIGBQb1RyZWVWaWV3SXRlbWAgcXVlIHNlcsOhIHJlbmRlcml6YWRhIHBlbG8gY29tcG9uZW50ZS5cbiAgICovXG4gIEBJbnB1dCgncC1pdGVtcycpIHNldCBpdGVtcyh2YWx1ZTogQXJyYXk8UG9UcmVlVmlld0l0ZW0+KSB7XG4gICAgdGhpcy5faXRlbXMgPSBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHRoaXMuZ2V0SXRlbXNCeU1heExldmVsKHZhbHVlKSA6IFtdO1xuICB9XG5cbiAgZ2V0IGl0ZW1zKCkge1xuICAgIHJldHVybiB0aGlzLl9pdGVtcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAb3B0aW9uYWxcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEhhYmlsaXRhIHVtYSBjYWl4YSBkZSBzZWxlw6fDo28gcGFyYSBzZWxlY2lvbmFyIGUvb3UgZGVzbWFyY2FyIHVtIGl0ZW0gZGEgbGlzdGEuXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICBASW5wdXQoJ3Atc2VsZWN0YWJsZScpIHNldCBzZWxlY3RhYmxlKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5fc2VsZWN0YWJsZSA9IGNvbnZlcnRUb0Jvb2xlYW4odmFsdWUpO1xuICB9XG5cbiAgZ2V0IHNlbGVjdGFibGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NlbGVjdGFibGU7XG4gIH1cblxuICBwcm90ZWN0ZWQgZW1pdEV4cGFuZGVkKHRyZWVWaWV3SXRlbTogUG9UcmVlVmlld0l0ZW0pIHtcbiAgICBjb25zdCBldmVudCA9IHRyZWVWaWV3SXRlbS5leHBhbmRlZCA/ICdleHBhbmRlZCcgOiAnY29sbGFwc2VkJztcblxuICAgIHRoaXNbZXZlbnRdLmVtaXQoeyAuLi50cmVlVmlld0l0ZW0gfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZW1pdFNlbGVjdGVkKHRyZWVWaWV3SXRlbTogUG9UcmVlVmlld0l0ZW0pIHtcbiAgICBjb25zdCBldmVudCA9IHRyZWVWaWV3SXRlbS5zZWxlY3RlZCA/ICdzZWxlY3RlZCcgOiAndW5zZWxlY3RlZCc7XG5cbiAgICB0aGlzLnVwZGF0ZUl0ZW1zT25TZWxlY3QodHJlZVZpZXdJdGVtKTtcblxuICAgIHRoaXNbZXZlbnRdLmVtaXQoeyAuLi50cmVlVmlld0l0ZW0gfSk7XG4gIH1cblxuICBwcml2YXRlIGFkZENoaWxkSXRlbUluUGFyZW50KGNoaWxkSXRlbTogUG9UcmVlVmlld0l0ZW0sIHBhcmVudEl0ZW06IFBvVHJlZVZpZXdJdGVtKSB7XG4gICAgaWYgKCFwYXJlbnRJdGVtLnN1Ykl0ZW1zKSB7XG4gICAgICBwYXJlbnRJdGVtLnN1Ykl0ZW1zID0gW107XG4gICAgfVxuXG4gICAgcGFyZW50SXRlbS5zdWJJdGVtcy5wdXNoKGNoaWxkSXRlbSk7XG4gIH1cblxuICAvLyBjYXNvIGhvdXZlciBwYXJlbnRJdGVtOlxuICAvLyAgLSBleHBhbmRlIG8gcGFyZW50SXRlbSBjYXNvIG8gZmlsaG8gZXN0aXZlciBleHBhbmRpZG87XG4gIC8vICAtIGFkaWNpb25hIG8gY2hpbGRJdGVtIG5vIHBhcmVudEl0ZW07XG4gIC8vICAtIG1hcmNhIG8gcGFyZW50SXRlbSBjYXNvIGNvbnRlciBzdWJJdGVtcyBtYXJjb2RvcyBvdSBudWxvcztcbiAgLy8gU2UgbsOjbyBjb250ZXIgcGFyZW50SXRlbSwgYWRpY2lvbmEgbyBjaGlsZEl0ZW0gbm8gaXRlbXMuXG4gIHByaXZhdGUgYWRkSXRlbShpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+LCBjaGlsZEl0ZW06IFBvVHJlZVZpZXdJdGVtLCBwYXJlbnRJdGVtPzogUG9UcmVlVmlld0l0ZW0pIHtcbiAgICBpZiAocGFyZW50SXRlbSkge1xuICAgICAgdGhpcy5leHBhbmRQYXJlbnRJdGVtKGNoaWxkSXRlbSwgcGFyZW50SXRlbSk7XG4gICAgICB0aGlzLmFkZENoaWxkSXRlbUluUGFyZW50KGNoaWxkSXRlbSwgcGFyZW50SXRlbSk7XG4gICAgICB0aGlzLnNlbGVjdEl0ZW1CeVN1Ykl0ZW1zKHBhcmVudEl0ZW0pO1xuXG4gICAgICBpdGVtcy5wdXNoKHBhcmVudEl0ZW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBpdGVtcy5wdXNoKGNoaWxkSXRlbSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3RBbGxJdGVtcyhpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+LCBpc1NlbGVjdGVkOiBib29sZWFuKSB7XG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGlmIChpdGVtLnN1Ykl0ZW1zKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0QWxsSXRlbXMoaXRlbS5zdWJJdGVtcywgaXNTZWxlY3RlZCk7XG4gICAgICB9XG5cbiAgICAgIGl0ZW0uc2VsZWN0ZWQgPSBpc1NlbGVjdGVkO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3RJdGVtQnlTdWJJdGVtcyhpdGVtOiBQb1RyZWVWaWV3SXRlbSkge1xuICAgIGl0ZW0uc2VsZWN0ZWQgPSB0aGlzLmV2ZXJ5SXRlbVNlbGVjdGVkKGl0ZW0uc3ViSXRlbXMpO1xuICB9XG5cbiAgLy8gcmV0b3JuYXLDoTpcbiAgLy8gIC0gdHJ1ZTogc2UgdG9kb3Mgb3MgaXRlbXMgZXN0aXZlcmVtIG1hcmNhZG9zO1xuICAvLyAgLSBudWxsOiBzZSBubyBtaW5pbW8gdW0gaXRlbSBlc3RlamEgbWFyY2FkbyBvdSBudWxsbyAoaW5kZXRlcm1pbmF0ZSlcbiAgLy8gIC0gZmFsc2U6IGNhc28gbsOjbyBjb3JyZXNwb25kYSBlbSBuZW5odW1hIGRhcyBvcMOnw7VlcyBhY2ltYSwgbm8gY2FzbywgbmVuaHVtIG1hcmNhZG8gb3UgbnVsbztcbiAgcHJpdmF0ZSBldmVyeUl0ZW1TZWxlY3RlZChpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+ID0gW10pOiBib29sZWFuIHwgbnVsbCB7XG4gICAgY29uc3QgaXRlbXNMZW5ndGggPSBpdGVtcy5sZW5ndGg7XG5cbiAgICBjb25zdCBsZW5ndGhDaGVja2VkSXRlbXMgPSBpdGVtcy5maWx0ZXIoaXRlbSA9PiBpdGVtLnNlbGVjdGVkKS5sZW5ndGg7XG5cbiAgICBpZiAoaXRlbXNMZW5ndGggJiYgaXRlbXNMZW5ndGggPT09IGxlbmd0aENoZWNrZWRJdGVtcykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgaGFzSW5kZXRlcm1pbmF0ZUl0ZW1zID0gaXRlbXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5zZWxlY3RlZCB8fCBpdGVtLnNlbGVjdGVkID09PSBudWxsKS5sZW5ndGg7XG5cbiAgICBpZiAoaGFzSW5kZXRlcm1pbmF0ZUl0ZW1zKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBleHBhbmRlIG8gaXRlbSBwYWkgY2FzbyBvIGZpbGhvIGVzdGl2ZXIgZXhwYW5kaWRvLlxuICBwcml2YXRlIGV4cGFuZFBhcmVudEl0ZW0oY2hpbGRJdGVtOiBQb1RyZWVWaWV3SXRlbSwgcGFyZW50SXRlbTogUG9UcmVlVmlld0l0ZW0pIHtcbiAgICBpZiAoY2hpbGRJdGVtLmV4cGFuZGVkKSB7XG4gICAgICBwYXJlbnRJdGVtLmV4cGFuZGVkID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEl0ZW1zQnlNYXhMZXZlbChcbiAgICBpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+ID0gW10sXG4gICAgbGV2ZWw6IG51bWJlciA9IDAsXG4gICAgcGFyZW50SXRlbT86IFBvVHJlZVZpZXdJdGVtLFxuICAgIG5ld0l0ZW1zID0gW11cbiAgKSB7XG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGNvbnN0IHsgc3ViSXRlbXMsIC4uLmN1cnJlbnRJdGVtIH0gPSBpdGVtO1xuXG4gICAgICBpZiAobGV2ZWwgPT09IHBvVHJlZVZpZXdNYXhMZXZlbCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHN1Ykl0ZW1zKSkge1xuICAgICAgICAvLyBjYXNvIHVtIGl0ZW0gcGFpIGluaWNpYXIgc2VsZWNpb25hZG8sIGRldmUgc2VsZWNpb25hciBvcyBmaWxob3MuXG4gICAgICAgIGlmIChjdXJyZW50SXRlbS5zZWxlY3RlZCkge1xuICAgICAgICAgIHRoaXMuc2VsZWN0QWxsSXRlbXMoc3ViSXRlbXMsIGN1cnJlbnRJdGVtLnNlbGVjdGVkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZ2V0SXRlbXNCeU1heExldmVsKHN1Ykl0ZW1zLCArK2xldmVsLCBjdXJyZW50SXRlbSk7XG4gICAgICAgIC0tbGV2ZWw7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYWRkSXRlbShuZXdJdGVtcywgY3VycmVudEl0ZW0sIHBhcmVudEl0ZW0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG5ld0l0ZW1zO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRJdGVtc1dpdGhQYXJlbnRTZWxlY3RlZChpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+ID0gW10sIHBhcmVudEl0ZW0/OiBQb1RyZWVWaWV3SXRlbSwgbmV3SXRlbXMgPSBbXSkge1xuICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBjb25zdCB7IHN1Ykl0ZW1zLCAuLi5jdXJyZW50SXRlbSB9ID0gaXRlbTtcblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc3ViSXRlbXMpKSB7XG4gICAgICAgIHRoaXMuZ2V0SXRlbXNXaXRoUGFyZW50U2VsZWN0ZWQoc3ViSXRlbXMsIGN1cnJlbnRJdGVtKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5hZGRJdGVtKG5ld0l0ZW1zLCBjdXJyZW50SXRlbSwgcGFyZW50SXRlbSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbmV3SXRlbXM7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUl0ZW1zT25TZWxlY3Qoc2VsZWN0ZWRJdGVtOiBQb1RyZWVWaWV3SXRlbSkge1xuICAgIGlmIChzZWxlY3RlZEl0ZW0uc3ViSXRlbXMpIHtcbiAgICAgIHRoaXMuc2VsZWN0QWxsSXRlbXMoc2VsZWN0ZWRJdGVtLnN1Ykl0ZW1zLCBzZWxlY3RlZEl0ZW0uc2VsZWN0ZWQpO1xuICAgIH1cblxuICAgIHRoaXMuX2l0ZW1zID0gdGhpcy5nZXRJdGVtc1dpdGhQYXJlbnRTZWxlY3RlZCh0aGlzLml0ZW1zKTtcbiAgfVxufVxuIl19